select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '36624','68841','33783','77213','13170','79739',
                          '99472','39561','92227','60271','32843',
                          '21817','28778','19098','77827','43513',
                          '83041','63811','97634','40980','37260',
                          '50027','38712','24527','88117','41394',
                          '39830','85486','55464','40958','57136',
                          '20195','29887','35002','21154','37254',
                          '55570','45669','75595','78125','34003',
                          '82050','20904','87723','16282','76901',
                          '59699','81254','83537','27987','48908',
                          '89620','92255','71254','25377','42600',
                          '58014','13976','19815','69064','14537',
                          '39941','81670','27809','72747','65630',
                          '58143','26518','54196','89268','76855',
                          '73974','27431','41331','40824','59506',
                          '32324','56753','91567','83449','26200',
                          '24439','66305','61502','20662','50670',
                          '19627','91138','25441','23178','68194',
                          '25351','65240','23506','49729','89746',
                          '27477','53636','86299','22408','50400',
                          '97036','57595','20261','30218','69778',
                          '48009','34600','99930','37253','19352',
                          '41007','16244','63041','75366','18362',
                          '99040','52784','78450','81725','57571',
                          '49893','29902','37548','89892','24739',
                          '13058','40975','59791','37315','58662',
                          '13853','27744','50330','35293','29096',
                          '45320','63455','95224','52290','87566',
                          '78906','16127','93052','98235','45814',
                          '76771','40961','37808','66221','77845',
                          '86645','11389','35227','45395','73594',
                          '28739','67845','12500','88966','85160',
                          '86781','11029','48243','37218','60906',
                          '74763','14383','80485','58811','74886',
                          '49791','16030','46731','61969','60937',
                          '48323','59569','41633','56043','76012',
                          '15590','87060','88278','28363','28491',
                          '30397','18821','41816','52992','31181',
                          '12670','95169','27992','14562','32999',
                          '15931','14696','18423','93809','20611',
                          '12762','60626','62821','73561','12984',
                          '11193','25536','67440','45804','94206',
                          '60557','35719','52104','11617','20095',
                          '79784','87554','19790','14288','58016',
                          '66036','32770','55681','24596','33729',
                          '55801','67247','13503','98029','14904',
                          '46863','37423','16446','85366','90809',
                          '10948','76530','19317','95204','12956',
                          '49867','53515','59252','76776','36204',
                          '13415','27884','23081','85670','48261',
                          '26738','41669','32532','37526','34201',
                          '15659','14220','99756','42561','83242',
                          '65160','15398','31977','39939','30925',
                          '11394','43826','48382','74646','36969',
                          '66742','35352','38210','65130','18554',
                          '16249','40971','40194','40774','38799',
                          '44306','13946','40299','21984','74332',
                          '53622','75401','78225','10592','70060',
                          '73017','23899','82702','21501','18207',
                          '35464','23179','35614','10399','11712',
                          '37879','88656','11130','65738','74188',
                          '15104','23721','68763','39915','51526',
                          '78327','48589','30590','11026','78878',
                          '80112','76431','69410','64126','48961',
                          '18337','32057','45481','54783','41102',
                          '34547','22847','71239','70001','24927',
                          '75036','32021','74153','60115','19594',
                          '21361','15113','52767','75399','82586',
                          '73730','12975','43271','76103','90918',
                          '16644','68445','82499','67748','43447',
                          '62384','13304','14474','15256','81749',
                          '87418','65659','37208','45407','63931',
                          '19825','55133','62081','50928','27013',
                          '87921','53951','71742','14279','90204',
                          '27997','27789','10899','73927','59180',
                          '22944','71171','64372','18781','89880',
                          '49342','82575','20001','73195','66250',
                          '12772','96311','89898','55696','19971',
                          '38159','92724','13651','27443','63230',
                          '49880','82489','91231','74864')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

